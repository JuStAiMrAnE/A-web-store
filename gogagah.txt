import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyD5Z1cBr-dCdZ7PKKbuYKaUKmiq5oS8lH4",
    authDomain: "just99cents-671d4.firebaseapp.com",
    projectId: "just99cents-671d4",
    storageBucket: "just99cents-671d4.firebasestorage.app",
    messagingSenderId: "718410856076",
    appId: "1:718410856076:web:880e92a8af24d9e360eda9"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let allProducts = [];
let currentCategory = 'all';

// --- Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firestore ---
async function fetchProducts() {
    const grid = document.getElementById('productGrid');
    grid.innerHTML = `<div class="col-span-full text-center py-20 font-black text-2xl animate-pulse opacity-50">Loading Assets...</div>`;

    try {
        const q = query(collection(db, "products"), orderBy("createdAt", "desc"));
        const snap = await getDocs(q);
        allProducts = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderProducts(allProducts);
    } catch (err) {
        grid.innerHTML = `<div class="col-span-full text-center py-20 text-red-500 font-bold">Error loading database. Please refresh.</div>`;
    }
}

// --- Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ø§Ù„ØµÙØ­Ø© ---
function renderProducts(products) {
    const grid = document.getElementById('productGrid');
    grid.innerHTML = "";

    if (products.length === 0) {
        grid.innerHTML = `<div class="col-span-full text-center py-20 opacity-50 font-bold">No products found in this category.</div>`;
        return;
    }

    products.forEach((p, pIndex) => {
        const imgList = p.images ? p.images.split(',').map(img => img.trim()) : [];
        if (!imgList.includes(p.image)) imgList.unshift(p.image);

        const card = document.createElement('div');
        card.className = "product-card group relative flex flex-col h-full";
        card.innerHTML = `
            <div class="relative overflow-hidden rounded-[1.8rem] mb-4 aspect-video bg-slate-100 dark:bg-slate-800">
                <div id="slider-${pIndex}" class="w-full h-full flex transition-transform duration-500 ease-out" style="transform: translateX(0%);">
                    ${imgList.map(img => `<img src="${img}" class="w-full h-full object-cover flex-shrink-0">`).join('')}
                </div>
                <div class="view-overlay absolute inset-0 flex items-center justify-center pointer-events-none opacity-0 group-hover:opacity-100 transition-opacity duration-300" style="background: rgba(79, 70, 229, 0.1);">
                    <span class="bg-white/90 dark:bg-slate-900/90 px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest shadow-xl dark:text-white">View Product</span>
                </div>
                ${imgList.length > 1 ? `
                    <button onclick="window.moveSlider(${pIndex}, -1, ${imgList.length})" class="slider-btn absolute left-3 top-1/2 -translate-y-1/2 w-8 h-8 rounded-full bg-white/90 flex items-center justify-center text-indigo-600 shadow-lg z-10 opacity-0 group-hover:opacity-100 transition-opacity">â®</button>
                    <button onclick="window.moveSlider(${pIndex}, 1, ${imgList.length})" class="slider-btn absolute right-3 top-1/2 -translate-y-1/2 w-8 h-8 rounded-full bg-white/90 flex items-center justify-center text-indigo-600 shadow-lg z-10 opacity-0 group-hover:opacity-100 transition-opacity">â¯</button>
                ` : ''}
                <div class="absolute bottom-3 left-1/2 -translate-x-1/2 flex gap-1.5 z-10">
                    ${imgList.map((_, i) => `<div id="dot-${pIndex}-${i}" class="dot ${i === 0 ? 'active' : ''} w-1.5 h-1.5 rounded-full bg-white/50 transition-all"></div>`).join('')}
                </div>
                <div class="absolute top-3 right-3 bg-white/90 dark:bg-slate-900/90 px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-tighter shadow-sm border border-slate-100 dark:border-slate-800 z-10">
                    ${p.category}
                </div>
            </div>
            <div class="px-1 flex-1 flex flex-col">
                <h3 class="text-lg font-black mb-1 truncate dark:text-white">${p.title}</h3>
                <p class="text-xs text-slate-500 dark:text-slate-400 mb-4 line-clamp-2 leading-relaxed">${p.desc || 'Premium template for professional creators.'}</p>
                <div class="flex items-center justify-between mt-auto">
                    <div class="flex flex-col">
                        <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Price</span>
                        <span class="text-xl font-black text-indigo-600">$${p.price || '0.99'}</span>
                    </div>
                    <div class="flex gap-2">
                        ${p.demo_url ? `<a href="${p.demo_url}" target="_blank" class="p-3 bg-slate-100 dark:bg-slate-800 rounded-xl hover:bg-indigo-600 hover:text-white transition-all shadow-sm">ğŸŒ</a>` : ''}
                        <button onclick="window.addToCart('${p.id}')" class="px-5 py-3 bg-indigo-600 text-white rounded-xl font-black text-sm shadow-lg shadow-indigo-500/20 hover:bg-black transition-all active:scale-90">
                            Get Now
                        </button>
                    </div>
                </div>
            </div>
        `;
        grid.appendChild(card);
    });
}

// --- Ù…Ø­Ø±Ùƒ Ø§Ù„Ø³Ù„Ø§ÙŠØ¯Ø± ---
window.sliderStates = {};
window.moveSlider = (pIndex, step, total) => {
    if (window.sliderStates[pIndex] === undefined) window.sliderStates[pIndex] = 0;
    let current = window.sliderStates[pIndex];
    current = (current + step + total) % total;
    window.sliderStates[pIndex] = current;
    const slider = document.getElementById(`slider-${pIndex}`);
    slider.style.transform = `translateX(-${current * 100}%)`;
    document.querySelectorAll(`[id^="dot-${pIndex}-"]`).forEach(dot => {
        dot.style.width = "6px"; dot.style.background = "rgba(255, 255, 255, 0.5)";
    });
    const activeDot = document.getElementById(`dot-${pIndex}-${current}`);
    activeDot.style.width = "12px"; activeDot.style.background = "white";
};

// --- Ù†Ø¸Ø§Ù… Ø§Ù„ÙÙ„ØªØ±Ø© ---
window.filterCat = (cat) => {
    currentCategory = cat;
    document.querySelectorAll('.cat-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.id === `cat-${cat}`) btn.classList.add('active');
    });
    const filtered = cat === 'all' ? allProducts : allProducts.filter(p => p.category.toLowerCase() === cat.toLowerCase());
    renderProducts(filtered);
};

// --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø³Ù„Ø© (Cart Logic) ---
window.cart = JSON.parse(localStorage.getItem('cart')) || [];

window.toggleCart = () => {
    const sidebar = document.getElementById('cartSidebar');
    const overlay = document.getElementById('cartOverlay');
    sidebar.classList.toggle('translate-x-full');
    overlay.classList.toggle('hidden');
    if (!overlay.classList.contains('hidden')) {
        overlay.style.opacity = "1";
    }
};

window.addToCart = (id) => {
    const product = allProducts.find(p => p.id === id);
    if (!product) return;
    if (!window.cart.find(item => item.id === id)) {
        window.cart.push(product);
        localStorage.setItem('cart', JSON.stringify(window.cart));
        window.updateCartUI();
    }
};

window.removeFromCart = (index) => {
    window.cart.splice(index, 1);
    localStorage.setItem('cart', JSON.stringify(window.cart));
    window.updateCartUI();
};

window.updateCartUI = () => {
    const cartItems = document.getElementById('cartItems');
    const cartCount = document.getElementById('cartCount');
    const cartTotal = document.getElementById('cartTotal');
    
    if (!cartItems) return;
    cartItems.innerHTML = "";
    let total = 0;

    window.cart.forEach((item, index) => {
        total += parseFloat(item.price || 0.99);
        const div = document.createElement('div');
        div.className = "flex items-center gap-4 bg-slate-50 dark:bg-slate-900/50 p-4 rounded-[1.5rem] border border-slate-100 dark:border-slate-800 transition-all hover:scale-[1.02]";
        div.innerHTML = `
            <img src="${item.image}" class="w-16 h-16 object-cover rounded-xl shadow-sm">
            <div class="flex-1 min-w-0">
                <h4 class="text-sm font-black dark:text-white truncate">${item.title}</h4>
                <p class="text-indigo-600 font-bold">$${item.price || '0.99'}</p>
            </div>
            <button onclick="window.removeFromCart(${index})" class="text-red-500 hover:bg-red-50 p-2 rounded-lg transition-colors">âœ•</button>
        `;
        cartItems.appendChild(div);
    });

    if (cartCount) cartCount.innerText = window.cart.length;
    if (cartTotal) cartTotal.innerText = `$${total.toFixed(2)}`;
};

// --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¯ÙŠØ³ÙƒÙˆØ±Ø¯ ÙˆØ§Ù„Ø®Ù„Ø§Øµ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ---
window.openSupport = () => {
    window.open("https://discord.gg/zYKEnZVGuE", "_blank");
};

window.startCheckout = () => {
    if (window.cart.length === 0) {
        alert("Your cart is empty!");
        return;
    }
    const total = document.getElementById('cartTotal').innerText;
    if(confirm(`Ready to purchase? Your total is ${total}. You will be redirected to our Discord for secure payment.`)) {
        window.openSupport(); 
    }
};

// ØªØ´ØºÙŠÙ„ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
fetchProducts();
window.updateCartUI();
